<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Phân ca và Target cho các bộ phận</title>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 6px;
        text-align: center;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 6px;
        width: 300px;
      }
    </style>
  </head>
  <body>
    <h3>Phân ca và Target cho các bộ phận</h3>
    <a href="/settings/shift">Danh mục Ca/Kíp</a>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Tên bộ phận</th>
          <th>Ca/Kíp</th>
          <th>Thời gian bắt đầu</th>
          <th>Thời gian kết thúc</th>
          <th>Thời gian làm việc</th>
          <th>Target</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody id="shiftAssignmentTableBody"></tbody>
    </table>

    <!-- Modal -->
    <div id="assignmentModal" class="modal">
      <div class="modal-content">
        <h4>Thiết lập ca & target</h4>
        <label>Ca/Kíp:</label>
        <select id="shiftSelect"></select>
        <br /><br />
        <label>Target:</label>
        <input type="number" id="targetInput" min="0" />
        <br /><br />
        <button onclick="saveAssignment()">Lưu</button>
        <button onclick="closeModal()">Hủy</button>
      </div>
    </div>

    <script>
      let currentDeptId = null;
      let currentShiftId = null;

      async function loadShiftAssignment() {
        try {
          const res = await fetch("/settings/shift/assignmentList");
          const data = await res.json();
          if (data.success) {
            const tbody = document.getElementById("shiftAssignmentTableBody");
            tbody.innerHTML = "";
            data.data.forEach((assign, index) => {
              const row = `<tr>
                          <td>${index + 1}</td>
                          <td>${assign.department_name}</td>
                          <td>${assign.shift_name || "-"}</td>
                          <td>${assign.start_time || "-"}</td>
                          <td>${assign.end_time || "-"}</td>
                          <td>${assign.duration || "-"}</td>
                          <td>${assign.target || "-"}</td>
                          <td>
                            <a href="#" onclick="openModal(${
                              assign.department_id
                            }, ${assign.shift_id || "null"}, ${
                assign.target || "null"
              }, ${assign.assignment_id || "null"})">Thiết lập</a>
                          </td>
                        </tr>`;
              tbody.innerHTML += row;
            });
          } else {
            alert(data.message || "Không thể tải dữ liệu");
          }
        } catch (err) {
          console.error("Lỗi truy vấn", err);
        }
      }

      async function loadShiftOptions(selectedId = null) {
        const res = await fetch("/settings/shift/list");
        const data = await res.json();
        const select = document.getElementById("shiftSelect");
        select.innerHTML = "";
        if (data.success) {
          data.data.forEach((shift) => {
            const opt = document.createElement("option");
            opt.value = shift.id;
            opt.textContent = `${shift.name} (${shift.started_at} - ${shift.finished_at})`;
            if (selectedId && shift.id === selectedId) opt.selected = true;
            select.appendChild(opt);
          });
        }
      }

      let currentAssignmentId = null;

      function openModal(deptId, shiftId, target, assignmentId) {
        currentDeptId = deptId;
        currentAssignmentId = assignmentId;
        document.getElementById("targetInput").value = target || "";
        loadShiftOptions(shiftId);
        document.getElementById("assignmentModal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("assignmentModal").style.display = "none";
      }

      async function saveAssignment() {
        const shift_id = document.getElementById("shiftSelect").value;
        const target = document.getElementById("targetInput").value;

        const res = await fetch("/settings/shift/assignment/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            assignment_id: currentAssignmentId, // Vẫn gửi ID nếu có
            department_id: currentDeptId,
            shift_id,
            target,
          }),
        });

        const data = await res.json();
        if (data.success) {
          alert("Lưu thành công");
          closeModal();
          loadShiftAssignment();
        } else {
          alert(data.message || "Lỗi khi lưu");
        }
      }

      window.onload = loadShiftAssignment;
    </script>
  </body>
</html>
